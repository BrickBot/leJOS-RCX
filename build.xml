<!--
  ==================================================
  Buildfile for java build of leJOS.
  $Id$
  ==================================================
-->
<project name="leJOS java build" default="all" basedir=".">

  <!--
    ==================================================
    Setting up the global properties for the build
    all paths should be relative
    ==================================================
  -->

  <property name="src" value="${basedir}/src"/>
  <property name="javasrc" value="${src}/java"/>
  <property name="build" value="${basedir}/build"/>
  <property name="bin" value="${basedir}/bin"/>
  <property name="lib" value="${basedir}/lib"/>

  <property name="org.lejos" value="${basedir}/../org.lejos"/>
  <property name="org.lejos.lib" value="${org.lejos}/lib"/>
  <property name="org.lejos.src" value="${org.lejos}/src"/>
  <property name="driver_win32" value="${org.lejos}/os/win32/x86"/>
  <property name="driver_linux" value="${org.lejos}/os/linux/x86"/>

  <!--
    ==================================================
    Target clean removes the class directory
    ==================================================
  -->
  <target name="clean" description="clean up all generated files">
    <!-- delete generated files -->
  	<delete file="${javasrc}/tools/js/tinyvm/SpecialClassConstants.java"/>
  	<delete file="${javasrc}/tools/js/tinyvm/SpecialSignatureConstants.java"/>
  	<!-- delete classes -->
    <mkdir dir="${build}"/>
    <delete dir="${build}/classes"/>
    <delete dir="${build}/rcxcomm"/>
    <delete dir="${build}/pcrcxcomm"/>
    <delete dir="${build}/tools"/>
    <delete dir="${build}/vision"/>
  	<!-- delete jars -->
  	<delete>
      <fileset dir="${lib}">
        <include name="classes.jar"/>
        <include name="rcxcomm.jar"/>
        <include name="pcrcxcomm.jar"/>
        <include name="jtools.jar"/>
        <include name="vision.jar"/>
      </fileset>  	
      <fileset dir="${lib}/src">
        <include name="classes-src.zip"/>
        <include name="rcxcomm-src.zip"/>
        <include name="pcrcxcomm-src.zip"/>
        <include name="vision-src.zip"/>
      </fileset>  	
  	</delete>	
  </target>

  <!--
    ==================================================
    Target init: makes a timestamp and the build dir
    ==================================================
  -->
  <target name="init" description="setup build">
    <tstamp/>
    <mkdir dir="${build}"/>
    <mkdir dir="${lib}"/>
  </target>

  <!--
    ==================================================
    Target jar: create classes jar (RCX: JDK 1.1)
    ==================================================
  -->
  <target name="classes" depends="init" description="generate classes jar">
    <mkdir dir="${build}/classes"/>
    <javac srcdir="${javasrc}/classes" destdir="${build}/classes" fork="yes" optimize="on" debug="on" source="1.3" target="1.1"/>
    <jar destfile="${lib}/classes.jar" basedir="${build}/classes" update="false"/>
    <zip destfile="${lib}/src/classes-src.zip" basedir="${javasrc}/classes" update="false"/>
  </target>

  <!--
    ==================================================
    Target jar: create rcxcomm jar (RCX: JDK 1.1)
    ==================================================
  -->
  <target name="rcxcomm" depends="init, classes" description="generate rcxcomm jar">
    <mkdir dir="${build}/rcxcomm"/>
    <javac srcdir="${javasrc}/rcxcomm" destdir="${build}/rcxcomm" fork="yes" optimize="on" debug="on" source="1.3" target="1.1">
      <classpath location="${lib}/classes.jar"/>
    </javac>
    <jar destfile="${lib}/rcxcomm.jar" basedir="${build}/rcxcomm" update="false"/>
    <zip destfile="${lib}/src/rcxcomm-src.zip" basedir="${javasrc}/rcxcomm" update="false"/>
  </target>

  <!--
    ==================================================
    Target jar: create pcrcxcomm jar (PC: JDK 1.4)
    ==================================================
  -->
  <target name="pcrcxcomm" depends="init" description="generate pcrcxcomm jar">
    <mkdir dir="${build}/pcrcxcomm"/>
    <javac srcdir="${javasrc}/pcrcxcomm" destdir="${build}/pcrcxcomm" fork="yes" optimize="on" debug="on" source="1.4"/>
    <jar destfile="${lib}/pcrcxcomm.jar" basedir="${build}/pcrcxcomm" update="false"/>
    <zip destfile="${lib}/src/pcrcxcomm-src.zip" basedir="${javasrc}/pcrcxcomm" update="false"/>
  </target>

  <!--
    ==================================================
    Target jar: create vision jar (PC: JDK 1.4)
    ==================================================
  -->
  <target name="vision" depends="init, pcrcxcomm" description="generate pcrcxcomm jar">
    <mkdir dir="${build}/vision"/>
    <copy todir="${build}/vision">
      <fileset dir="${javasrc}/vision">
        <include name="**/*.properties"/>
      </fileset>
    </copy>
    <javac srcdir="${javasrc}/vision" destdir="${build}/vision" fork="yes" optimize="on" debug="on" source="1.4">
      <classpath path="${lib}/jmf.jar:${lib}/pcrcxcomm.jar" />
    </javac>
    <jar destfile="${lib}/vision.jar" basedir="${build}/vision" update="false"/>
    <zip destfile="${lib}/src/vision-src.zip" basedir="${javasrc}/vision" update="false"/>
  </target>

  <!--
    ==================================================
    Target jar: create jtools jar (PC: JDK 1.4)
    ==================================================
  -->
  <target name="jtools" depends="init, pcrcxcomm" description="generate jtools jar">
    <mkdir dir="${build}/tools"/>
    <!-- generate constants first -->
    <javac srcdir="${javasrc}/tools" destdir="${build}/tools" fork="yes" optimize="on" debug="on" source="1.4" includes="**/GenerateConstants.java"/>
    <java classpath="${build}/tools" classname="js.tinyvm.GenerateConstants">
      <sysproperty key="tinyvm.home" value="${src}"/>
    </java>
    <!-- generate tools -->
    <javac srcdir="${javasrc}/tools" destdir="${build}/tools" fork="yes" optimize="on" debug="on" source="1.4">
      <classpath location="${lib}/pcrcxcomm.jar"/>
      <classpath location="${lib}/commons-cli-1.0.jar"/>
      <classpath location="${lib}/bcel-5.1.jar"/>
    </javac>
    <jar destfile="${lib}/jtools.jar" basedir="${build}/tools" update="false">
      <fileset dir="${bin}">
        <include name="lejos.srec"/>
        <include name="fastdl2x.srec"/>
        <include name="fastdl4x.srec"/>
      </fileset>
    </jar>
  </target>

  <!--
    ==================================================
    Target jar: deploy all files (does NOT generate anything)
    ==================================================
  -->
  <target name="deploy" depends="" description="deploy all files">
  	<!-- all leJOS libs -->
    <mkdir dir="${org.lejos.lib}"/>
    <delete>
      <fileset dir="${org.lejos.lib}">
        <include name="*.jar"/>
      </fileset>
    </delete>
    <copy todir="${org.lejos.lib}">
      <fileset dir="${lib}">
        <include name="*.jar"/>
      </fileset>
    </copy>
  	<!-- sources for all leJOS and external libs -->
    <mkdir dir="${org.lejos.src}"/>
    <delete>
      <fileset dir="${org.lejos.src}">
        <include name="*.zip"/>
      </fileset>
    </delete>
    <copy todir="${org.lejos.src}">
      <fileset dir="${lib}/src">
        <include name="*.zip"/>
        <exclude name="bcel*"/>
      </fileset>
    </copy>
  	<!-- OS specific drivers (win32) -->
    <mkdir dir="${driver_win32}"/>
    <!--delete>
      <fileset dir="${driver_win32}">
        <include name="*.dll"/>
      </fileset>
    </delete-->
   <copy todir="${driver_win32}" overwrite="true">
      <fileset dir="${bin}">
        <include name="*.dll"/>
      </fileset>
    </copy>
  	<!-- OS specific drivers (linux) -->
  	<mkdir dir="${driver_linux}"/>
    <!--delete>
      <fileset dir="${driver_linux}">
        <include name="*.so"/>
      </fileset>
    </delete-->
    <copy todir="${driver_linux}" overwrite="true">
      <fileset dir="${bin}">
        <include name="*.so"/>
      </fileset>
    </copy>
  </target>
  
  <!--
    ==================================================
    Target jar: create all jar files
    ==================================================
  -->
  <target name="all" depends="classes, rcxcomm, pcrcxcomm, vision, jtools, deploy" description="make all"/>
	  
  <!--
    ==================================================
    Target jar: create leJOS API docs
    ==================================================
  -->
  <target name="doc" depends="" description="generate leJOS API docs">
    <delete dir="${basedir}/apidocs"/>
    <mkdir dir="${basedir}/apidocs"/>
    <!-- packages: java.io java.lang java.util josx.platform.rcx josx.util josx.robotics josx.rcxcomm java.net javax.servlet.http -->
    <javadoc protected="true"
             windowtitle="leJOS API documentation"
             author="true"
             destdir="${basedir}/apidocs"
             source="1.1"
             defaultexcludes="yes">
      <fileset dir="${javasrc}/classes"/>
      <fileset dir="${javasrc}/rcxcomm"/>
    </javadoc>
  </target>

  <!--
    ==================================================
    Target jar: create leJOS PC API docs
    ==================================================
  -->
  <target name="pcdoc" depends="init" description="generate leJOS PC API docs">
    <delete dir="${basedir}/pcapidocs"/>
    <mkdir dir="${basedir}/pcapidocs"/>
    <!-- packages: josx.rcxcomm -->
    <javadoc protected="true"
             windowtitle="leJOS PC API documentation"
             author="true"
             destdir="${basedir}/pcapidocs"
             source="1.4"
             defaultexcludes="yes">
      <fileset dir="${javasrc}/pcrcxcomm"/>
    </javadoc>
  </target>

  <!--
    ==================================================
    Target jar: create leJOS Vision API docs
    ==================================================
  -->
  <target name="visiondoc" depends="init, pcrcxcomm" description="generate leJOS Vision API docs">
    <delete dir="${basedir}/pcapidocs"/>
    <mkdir dir="${basedir}/pcapidocs"/>
    <!-- packages: josx.vision -->
    <javadoc protected="true"
             windowtitle="leJOS Vision API documentation"
             author="true"
             destdir="${basedir}/visionapidocs"
             source="1.4"
             defaultexcludes="yes">
      <classpath location="${lib}/pcrcxcomm.jar"/>
      <fileset dir="${javasrc}/vision"/>
    </javadoc>
  </target>

  <!--
    ==================================================
    Target jar: create leJOS Vision API docs
    ==================================================
  -->
  <target name="alldocs" depends="doc, pcdoc, visiondoc" description="generate all API docs"/>

</project>
