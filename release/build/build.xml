<!-- build file for building the os dependent parts of the lejos distribution -->
<!-- do not change this file -->

<project name="leJOS distribution" default="build" basedir=".">
	
	<!-- Setting up the global properties for the build -->
  	<property file="build.properties" />
	<property name="lejos.dist.root" value="${basedir}/.."/>
	<property name="lejos.dist.bin" value="${lejos.dist.root}/bin"/>
	<property name="lejos.dist.3rdparty.libs" value="${lejos.dist.root}/3rdparty/lib"/>
	<property name="lejos.dist.src" value="${lejos.dist.root}/src"/>
	<property name="lejos.dist.emu.src" value="${lejos.dist.src}/tools/emu-lejos"/>
	<property name="irctrcx.lib.src" value="${lejos.dist.src}/comms/libirtrcx"/>
	<property name="jirctrcx.lib.src" value="${lejos.dist.src}/comms/libjirtrcx"/>
	<property name="plat.unix.src" value="${lejos.dist.src}/platform/unix"/>
	<property name="javavm.src" value="${lejos.dist.src}/javavm"/>
	<property name="lejos.version" value="lejos 3"/>
	<property name="make.out" value="${lejos.dist.bin}"/>

	<!-- cpptasks task & type def -->
	<taskdef resource="cpptasks.tasks">
	  <classpath>
	    <pathelement location="${lejos.dist.3rdparty.libs}/cpptasks.jar"/>
	  </classpath>
	</taskdef>
	<typedef resource="cpptasks.types">
	  <classpath>
	    <pathelement location="${lejos.dist.3rdparty.libs}/cpptasks.jar"/>
	  </classpath>
	</typedef>
	
	<!-- build the os dependent parts of the lejos distribution --> 
	<target name="build" depends ="clean,emulator,irctrcx.libs,jirctrcx.libs,emu.runtime,clear" 
		description="build the os dependent parts of the lejos distribution">
		<echo message="Done."/>
	</target>

  	<!-- cleans the os dependent parts of the lejos distribution -->
	<target name="clean" description="cleans the os dependent parts of the lejos distribution">
	    <!-- move existing files to *.bak -->
		<echo message="saving existing files to .bak files"/>
		<move todir="${lejos.dist.bin}">
			<fileset dir="${lejos.dist.bin}">
				<include name="emu-*"/>	
				<include name="*.so"/>	
				<include name="*.dll"/>	
		      	<exclude name="*.bak"/>
		    </fileset>
		    <mapper type="glob" from="*" to="*.bak"/>
		</move>
  	</target>
  	
  	<!-- clears the transient artifacts generated by the build -->
	<target name="clear" description="clears the transient artifacts generated by the build">
		<delete>
			<fileset dir="${lejos.dist.bin}">
				<include name="*.xml"/>	
		    </fileset>
		</delete>
  	</target>

	<!-- builds the emulator -->
  	<target name="emulator" description="builds the emulator">
  		<ant antfile="${lejos.dist.emu.src}/build.xml" dir="${lejos.dist.emu.src}" inheritall="true" />
  	</target>

	<!-- builds the irctrcx libraries -->
	<target name="irctrcx.libs" description="builds the irctrcx libraries">
		<exec executable="make" failonerror="true" dir="${irctrcx.lib.src}">
			<arg line="OSTYPE=${lejos.ostype} LEJOS_HOME=${lejos.dist.root} BIN_TARGET=${make.out}"/>
		</exec> 
	</target>

	<!-- builds the jirctrcx libraries -->
	<target name="jirctrcx.libs" depends="irctrcx.libs" description="builds the jirctrcx libraries">
		<exec executable="make" failonerror="true" dir="${jirctrcx.lib.src}">
			<arg line="OSTYPE=${lejos.ostype} LEJOS_HOME=${lejos.dist.root} BIN_TARGET=${make.out} TRACE=${trace}"/>
		</exec> 
  	</target>

  	<!-- builds the emu runtime tools (emu-dump & emu-lejosrun) -->
  	<target name="emu.runtime" depends="emulator" description="builds the emu runtime tools">
  		<ant antfile="${plat.unix.src}/build.xml" dir="${plat.unix.src}" inheritall="true" />
  	</target>
	
</project>
